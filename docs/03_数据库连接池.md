数据库连接池
===============

数据库连接池
> * 单例模式，保证唯一
> * list实现连接池
> * 连接池为静态大小
> * 互斥锁实现线程安全


## 背景

+ 背景

  由于服务器需要频繁地访问数据库，即需要频繁创建和断开数据库连接，该过程是一个很耗时的操作，也会对数据库造成安全隐患。在程序初始化的时候，集中创建并管理多个数据库连接，可以保证较快的数据库读写速度，更加安全可靠。

+ 池：一组资源的集合，这组资源在服务器启动之初就被完全创建好并初始化

+ 数据库连接池：连接池中的资源为一组数据库连接，由程序动态地对池中的连接进行使用，释放

+ 作用

  当系统开始处理客户请求的时候，如果它需要相关的资源，可以直接从池中获取，无需动态分配；当服务器处理完一个客户连接后,可以把相关的资源放回池中，无需执行系统调用释放资源。

+ RAII, Resource Acquisition Is Initialization，资源获取就是初始化

  C++的语言机制保证，当一个对象创建时会自动调用构造函数，当对象超出作用域时会自动调用析构函数。所以可以使用类来管理资源，在构造函数中申请分配资源，在析构函数中释放资源。 RAII的核心思想是将资源与对象的生命周期绑定。

## 功能

![image-20230315123811088](./assets/image-20230315123811088.png)

+ 数据库连接池为上图中，网络存储单元 + 请求队列（网络存储单元、逻辑单元之间）

+ 连接池中的资源为一组数据库连接，由程序动态地对池中的连接进行使用，释放
+ 数据库连接池，在该项目中设计为线程池的一个成员变量

## 成员变量

+ 线程同步机制类：逻辑单元从连接池中获取连接时，确保对资源的独占式访问
  + 互斥锁
  + 信号量
+ 数据库连接池
  + 双线链表实现
  + 连接池中最大连接数的选取
  + 当前已使用的连接数
  + 当前空闲的连接数
+ 数据库信息
  + 数据库主机地址
  + 数据库端口号
  + 登陆数据库用户名
  + 登陆数据库密码
  + 使用数据库名

```c++
class connection_pool {
private:
    unsigned int MaxConn;  // 最大连接数
    unsigned int CurConn;  // 当前已使用的连接数
    unsigned int FreeConn; // 当前空闲的连接数

private:
    locker       lock;     // 互斥锁
    list<MYSQL*> connList; // 双向循环链表实现连接池
    sem          reserve;  // 信号量

private:
    string url;          // 数据库主机地址
    string Port;         // 数据库端口号
    string User;         // 登陆数据库用户名
    string PassWord;     // 登陆数据库密码
    string DatabaseName; // 使用数据库名
};
```

## 成员函数

+ 构造函数（private）

  + 当前连接数置 0
  + 空闲连接数置 0

+ 析构函数（private）

  + 调用 销毁数据库连接池函数

+ 创建实例（静态）

  > 在头文件中修饰函数声明，不用在 .cpp 文件中修饰函数实现

  + 创建一个静态连接池类
  + 返回连接池类的指针

+ 初始化

  + 用户输入：数据库信息
  + （加锁）创建连接池内的连接（最大连接数确定创建个数），每创建一个新连接，空闲连接数 + 1
  + 信号量初始化为空闲连接数，即最大连接数
  + 最大连接数设为空闲连接数

+ 池中当前空闲连接数

  + 返回成员变量值：空闲连接数

+ 获取连接

  + 本质上是对链表的操作

  + 信号量 -1

  + （加锁）获取连接即是从双向链表取出一个元素

  + （加锁）更新空闲连接数（- 1）、已使用连接数（+ 1）

+ 释放连接

  + 本质上是对链表的操作

  + （加锁）往链表放回连接元素

  + （加锁）更新空闲连接数（+ 1）、已使用连接数（- 1）

  + 信号量 -1

+ 销毁数据库连接池

  + （加锁）遍历链表，关闭链表中存储的连接元素
  + （加锁）重置空闲连接数（0）、已使用连接数（0）


## Reference

+ https://mp.weixin.qq.com/s/7ayetU5tYn3k6K59G5adSA
+ [数据库连接池](https://blog.csdn.net/weixin_46778443/article/details/124025900)
